<script>
const CSV_URL = 'data.csv?v=' + Date.now(); // 캐시 방지

const tabs = document.querySelectorAll('.tab');
const grid = document.getElementById('cards');

function parseCSV(text){
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
  const header = lines.shift().split(',').map(s=>s.trim());
  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));

  const rows = lines.map(line=>{
    // 쉼표가 데이터 안에 들어가는 경우는 현재 데이터 구조상 거의 없다고 보고 단순 split
    const cols = line.split(',');
    return {
      carrier: (cols[idx.carrier]||'').trim().toLowerCase(), // skt/kt/lg/internet 등
      title:   (cols[idx.title]||'').trim(),
      tag:     (cols[idx.tag]||'').trim(),                 // 번호이동/기기변경
      price:   (cols[idx.price]||'').trim(),
      priceType:(cols[idx.priceType]||'').trim(),          // free/minus/cash 등
      sub:     (cols[idx.sub]||'').trim()
    };
  });
  return rows;
}

function formatPrice(price, priceType){
  const n = Number(price);
  if (Number.isNaN(n)) return price;

  // 기본은 "만원" 단위 표시(기존 UI와 맞춤)
  // 음수는 표시 정책이 필요하면 여기서 조정 가능
  if (priceType === 'cash') return `${n}만원`;
  if (priceType === 'minus') return `${n}만원`; // 필요시 "마-5" 같은 표기로 변경 가능
  // free 포함 기본
  return `${n}만원`;
}

function makeCardHTML(model, left, right, activeCat){
  // left/right: {tag, price, priceType, sub}
  const leftHtml = left ? `
    <div class="card" data-cat="${activeCat},특가폰">
      <div class="model">${model}</div>
      <div class="price">${formatPrice(left.price, left.priceType)}</div>
      <div class="cond">${left.tag}</div>
      <div class="sub">${left.sub}</div>
    </div>` : '';

  const rightHtml = right ? `
    <div class="card" data-cat="${activeCat},특가폰">
      <div class="model">${model}</div>
      <div class="price">${formatPrice(right.price, right.priceType)}</div>
      <div class="cond">${right.tag}</div>
      <div class="sub">${right.sub}</div>
    </div>` : '';

  return leftHtml + rightHtml;
}

function carrierToTab(carrier){
  if (carrier === 'skt') return 'SK';
  if (carrier === 'kt') return 'KT';
  if (carrier === 'lg') return 'LG';
  if (carrier === 'internet') return '인터넷TV';
  if (carrier === 'mvno') return '알뜰요금';
  return '특가폰';
}

async function loadAndRender(){
  const res = await fetch(CSV_URL, {cache:'no-store'});
  const text = await res.text();
  const rows = parseCSV(text);

  // 그룹키: carrier+title
  const map = new Map();
  for (const r of rows){
    const tab = carrierToTab(r.carrier);
    const key = `${tab}||${r.title}`;
    if (!map.has(key)) map.set(key, {tab, title:r.title, left:null, right:null});
    const item = map.get(key);

    if (r.tag.includes('번호이동')) item.left = r;
    else if (r.tag.includes('기기변경')) item.right = r;
    else {
      // 기타 태그는 오른쪽에 넣음(필요시 조정)
      item.right = r;
    }
  }

  // 렌더(기존 하드코딩 카드 제거)
  grid.innerHTML = '';

  // 탭별로 묶어서 출력(현재 선택 탭만 보이게)
  const items = Array.from(map.values());

  // 기본 활성 탭
  const activeTab = document.querySelector('.tab.active')?.dataset.cat || 'SK';

  // 활성 탭 먼저, 그 다음 나머지(원하면 정렬 변경 가능)
  items.sort((a,b)=>{
    if (a.tab === activeTab && b.tab !== activeTab) return -1;
    if (a.tab !== activeTab && b.tab === activeTab) return 1;
    return a.title.localeCompare(b.title, 'ko');
  });

  for (const it of items){
    // 좌(번호이동) / 우(기기변경) 페어로 두 장 생성
    const html = makeCardHTML(it.title, it.left, it.right, it.tab);
    grid.insertAdjacentHTML('beforeend', html);
  }

  // 탭 필터 적용(기존 로직 유지)
  applyFilter(activeTab);
}

function applyFilter(cat){
  const cards = document.querySelectorAll('.card');
  cards.forEach(c=>{
    const list = c.dataset.cat.split(',');
    c.style.display = list.includes(cat) ? 'flex' : 'none';
  });
}

tabs.forEach(t=>{
  t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    applyFilter(t.dataset.cat);
  });
});

// 실행
loadAndRender().catch(err=>{
  console.error(err);
  // 실패 시 아무것도 안 보이는 것보단 메시지
  grid.innerHTML = `<div style="padding:12px;color:#ef4444;font-weight:800;">데이터 로드 실패: data.csv 확인 필요</div>`;
});
</script>
