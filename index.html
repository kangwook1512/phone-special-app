<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>복지관2층매장</title>

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --ink:#1f2937;
  --muted:#6b7280;
  --line:#e5e7eb;
  --price:#ef4444;
  --tab:#2563eb;
  --call:#22c55e;
  --sms:#38bdf8;
  --kakao:#fee500;
}
*{box-sizing:border-box;}
html,body{margin:0;padding:0;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* 상단 탭(6개, 2열 3줄) */
.tabs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  background:#fff;
  border-bottom:1px solid var(--line);
}
.tab{
  padding:14px 0;
  text-align:center;
  font-weight:900;
  border-radius:12px;
  background:#f3f4f6;
  cursor:pointer;
  user-select:none;
}
.tab.active{ background:var(--tab); color:#fff; }

/* 카드 */
.main{padding:12px;padding-bottom:190px;}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.card{
  background:var(--card);
  border-radius:18px;
  padding:18px 16px;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
}
.model{font-size:18px;font-weight:900;margin-bottom:8px;}
.price{font-size:32px;font-weight:900;color:var(--price);margin-bottom:10px;}
.cond{font-size:14px;font-weight:800;margin-bottom:6px;}
.sub{font-size:13px;color:var(--muted);font-weight:700;}

/* 섹션(통신사별 묶음) */
.section-title{
  grid-column:1 / -1;
  font-weight:900;
  font-size:14px;
  color:var(--muted);
  padding:6px 4px 0;
}

/* 하단 */
.footer{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-top:1px solid var(--line);
}
.footer-msg{text-align:center;padding:10px;font-size:14px;font-weight:800;}
.footer-store{text-align:center;font-size:18px;font-weight:900;padding-bottom:6px;}
.footer-actions{display:grid;grid-template-columns:1fr 1fr 1fr;}
.footer-actions a{
  text-align:center;padding:16px 0;
  font-weight:900;text-decoration:none;color:#111;
}
.call{background:var(--call);color:#fff;}
.sms{background:var(--sms);color:#fff;}
.kakao{background:var(--kakao);}
</style>
</head>

<body>

<!-- 상단 탭(6개 고정) -->
<div class="tabs">
  <div class="tab active" data-cat="SK">SK</div>
  <div class="tab" data-cat="KT">KT</div>
  <div class="tab" data-cat="LG">LG</div>
  <div class="tab" data-cat="SPECIAL">특가폰</div>
  <div class="tab" data-cat="INTV">인터넷TV</div>
  <div class="tab" data-cat="MVNO">알뜰요금</div>
</div>

<!-- 카드 영역 -->
<div class="main">
  <div class="grid" id="cards"></div>
</div>

<!-- 하단 -->
<div class="footer">
  <div class="footer-msg">액정필름 무료교체 (카톡주문필수)</div>
  <div class="footer-store">복지관2층매장</div>
  <div class="footer-actions">
    <a class="call" href="tel:042-821-2272">전화</a>
    <a class="sms" href="sms:010-5839-1512">문자</a>
    <a class="kakao" href="https://open.kakao.com/o/s729bI5h" target="_blank" rel="noopener">카톡</a>
  </div>
</div>

<script>
const CSV_URL = 'data.csv?v=' + Date.now();
const grid = document.getElementById('cards');
const tabs = Array.from(document.querySelectorAll('.tab'));

/** ====== 안전 원칙 ======
 * - 내부값(마진/리베이트/정산)은 "파싱 자체를 하지 않음" => 화면 노출 경로 0
 * - 화면 출력은 title/display_price/sub_price/warn/note만 사용
 */

/** 최소 CSV 파서 (따옴표 처리) */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').trim().split('\n').filter(Boolean);
  if(lines.length === 0) return [];

  const headers = splitCSVLine(lines.shift()).map(h => h.trim());
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

  return lines.map(line=>{
    const cols = splitCSVLine(line);
    const get = (k)=> (idx[k] != null ? (cols[idx[k]] ?? '').trim() : '');

    // ✅ 분류/표시에 필요한 것만 파싱 (payout/margin_* 절대 금지)
    return {
      type: get('type'),
      carrier: get('carrier'),
      title: get('title'),
      display_price: get('display_price'),
      sub_price: get('sub_price'),
      warn: get('warn'),
      note: get('note')
    };
  });
}

function splitCSVLine(line){
  const out = [];
  let cur = '';
  let inQ = false;

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === ',' && !inQ){
      out.push(cur);
      cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function escapeHTML(str){
  return (str ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function cardHTML(model, price, cond, sub){
  return `
  <div class="card">
    <div class="model">${escapeHTML(model)}</div>
    <div class="price">${escapeHTML(price)}</div>
    <div class="cond">${escapeHTML(cond || '')}</div>
    <div class="sub">${escapeHTML(sub || '')}</div>
  </div>`;
}

/** 정규화 */
function T(x){ return (x||'').toString().trim().toUpperCase(); }
function normCarrier(v){
  const x = T(v).replace(/\s+/g,'');
  if(x.includes('SK')) return 'SK';
  if(x.includes('KT')) return 'KT';
  if(x.includes('LG') || x.includes('LGU') || x.includes('U+')) return 'LG';
  return x;
}

/** type 판별(유연) */
function isPhoneType(type){
  // PHONE, PHONE_LOW, PHONE_HIGH 등 PHONE*이면 전부 휴대폰
  return T(type).startsWith('PHONE');
}
function isIntvType(type){
  const x = T(type);
  if(!x) return false;
  if(x.includes('INTV')) return true;
  if(x.includes('INTERNET')) return true;
  if(x.includes('IPTV')) return true;
  if(x.includes('TV') && !x.startsWith('PHONE')) return true;
  return false;
}
function isMvnoType(type){
  const x = T(type);
  if(!x) return false;
  if(x.includes('MVNO')) return true;
  if(x.includes('ALTTEL')) return true;
  if(x.includes('ALT')) return true;
  if(x.includes('알뜰')) return true;
  if(x.includes('요금')) return true;
  return false;
}
function isSpecialType(type){
  const x = T(type);
  if(!x) return false;
  if(x.includes('SPECIAL')) return true;
  if(x.includes('특가')) return true;
  return false;
}

/** 가격 표시 */
function formatPrice(v){
  const s = (v ?? '').toString().trim();
  if(!s) return '';
  if(/[원월]/.test(s)) return s;
  if(/[가-힣]/.test(s)) return s;
  const n = Number(s.replace(/,/g,''));
  if(!isNaN(n)) return `${s}만원`;
  return s;
}

/** 휴대폰: "이동 57 / 기변 55"면 2장 카드로 분리 */
function splitPhoneCards(row){
  const s = (row.display_price ?? '').trim();
  const m = s.match(/이동\s*([-\d.,]+)\s*\/\s*기변\s*([-\d.,]+)/);

  // ⚠️ 내부/마진 문구 금지: WARN라도 "조건 확인"만 표시
  const safeSub = (row.warn === 'WARN') ? '조건 확인' : (row.sub_price || '');

  if(!m){
    return [{
      model: row.title,
      price: formatPrice(row.display_price),
      cond: row.note || '이동/기변',
      sub: safeSub
    }];
  }

  const move = m[1];
  const chg  = m[2];
  const note = row.note || '';

  return [
    { model: row.title, price: formatPrice(move), cond: '번호이동', sub: note || safeSub },
    { model: row.title, price: formatPrice(chg),  cond: '기기변경', sub: note || safeSub }
  ];
}

function emptyHTML(msg){
  return `
    <div class="card" style="grid-column:1 / -1;">
      <div class="model">${escapeHTML(msg)}</div>
      <div class="sub">data.csv의 type / carrier 값만 확인하면 됩니다.</div>
    </div>
  `;
}

/** 통신사별 묶음 렌더링 */
function renderGroupedByCarrier(items, label){
  const map = new Map();
  items.forEach(r=>{
    const c = (r.carrier||'').trim() || '기타';
    if(!map.has(c)) map.set(c, []);
    map.get(c).push(r);
  });

  const order = ['SK','KT','LG','SK망','KT망','LG망'];
  const carriers = Array.from(map.keys()).sort((a,b)=>{
    const ia = order.indexOf(a), ib = order.indexOf(b);
    if(ia === -1 && ib === -1) return a.localeCompare(b, 'ko');
    if(ia === -1) return 1;
    if(ib === -1) return -1;
    return ia - ib;
  });

  carriers.forEach(c=>{
    grid.insertAdjacentHTML('beforeend', `<div class="section-title">${escapeHTML(label)} · ${escapeHTML(c)}</div>`);
    map.get(c).forEach(r=>{
      grid.insertAdjacentHTML(
        'beforeend',
        cardHTML(r.title, formatPrice(r.display_price), r.note || label, (r.warn === 'WARN') ? '조건 확인' : (r.sub_price || ''))
      );
    });
  });
}

/** 렌더 */
function render(cat){
  fetch(CSV_URL,{cache:'no-store'})
    .then(r=>r.text())
    .then(t=>{
      const rows = parseCSV(t);
      grid.innerHTML='';

      // SK/KT/LG = 이동/기변 휴대폰만
      if(cat === 'SK' || cat === 'KT' || cat === 'LG'){
        const picked = rows.filter(r => isPhoneType(r.type) && normCarrier(r.carrier) === cat);

        picked.forEach(r=>{
          splitPhoneCards(r).forEach(c=>{
            grid.insertAdjacentHTML('beforeend', cardHTML(c.model, c.price, c.cond, c.sub));
          });
        });

        if(!grid.innerHTML.trim()){
          grid.innerHTML = emptyHTML(`${cat} 휴대폰 항목이 비어있음`);
        }
        return;
      }

      // 특가폰(현재 없으면 비어있게)
      if(cat === 'SPECIAL'){
        const picked = rows.filter(r => isSpecialType(r.type));
        if(picked.length === 0){
          grid.innerHTML = emptyHTML('특가폰 항목이 비어있음');
          return;
        }
        picked.forEach(r=>{
          grid.insertAdjacentHTML(
            'beforeend',
            cardHTML(r.title, formatPrice(r.display_price), r.note || '특가폰', (r.warn === 'WARN') ? '조건 확인' : (r.sub_price || ''))
          );
        });
        return;
      }

      // 인터넷TV = 통신사별 묶음
      if(cat === 'INTV'){
        const picked = rows.filter(r => isIntvType(r.type));
        if(picked.length === 0){
          grid.innerHTML = emptyHTML('인터넷TV 항목이 비어있음');
          return;
        }
        renderGroupedByCarrier(picked, '인터넷TV');
        return;
      }

      // 알뜰요금 = 통신사(망)별 묶음
      if(cat === 'MVNO'){
        const picked = rows.filter(r => isMvnoType(r.type));
        if(picked.length === 0){
          grid.innerHTML = emptyHTML('알뜰요금 항목이 비어있음');
          return;
        }
        renderGroupedByCarrier(picked, '알뜰요금');
        return;
      }

      grid.innerHTML = emptyHTML('항목이 비어있음');
    })
    .catch(()=>{
      grid.innerHTML = `
        <div class="card" style="grid-column:1 / -1;">
          <div class="model">data.csv 읽기 실패</div>
          <div class="sub">파일명(data.csv)과 업로드 위치를 확인하세요.</div>
        </div>
      `;
    });
}

// 탭 클릭
tabs.forEach(t=>{
  t.onclick=()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    render(t.dataset.cat);
  };
});

// 최초 로딩
render('SK');
</script>

</body>
</html>
