<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>복지관2층매장</title>

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --ink:#1f2937;
  --muted:#6b7280;
  --line:#e5e7eb;
  --price:#ef4444;
  --tab:#2563eb;
  --call:#22c55e;
  --sms:#38bdf8;
  --kakao:#fee500;
}
*{box-sizing:border-box;}
html,body{margin:0;padding:0;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* 상단 탭 */
.tabs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  background:#fff;
  border-bottom:1px solid var(--line);
}
.tab{
  padding:14px 0;
  text-align:center;
  font-weight:900;
  border-radius:12px;
  background:#f3f4f6;
  cursor:pointer;
}
.tab.active{
  background:var(--tab);
  color:#fff;
}

/* 카드 */
.main{padding:12px;padding-bottom:190px;}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.card{
  background:var(--card);
  border-radius:18px;
  padding:18px 16px;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
}
.model{font-size:18px;font-weight:900;margin-bottom:8px;}
.price{font-size:32px;font-weight:900;color:var(--price);margin-bottom:10px;}
.cond{font-size:14px;font-weight:800;margin-bottom:6px;}
.sub{font-size:13px;color:var(--muted);font-weight:700;}

/* 하단 */
.footer{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-top:1px solid var(--line);
}
.footer-msg{text-align:center;padding:10px;font-size:14px;font-weight:800;}
.footer-store{text-align:center;font-size:18px;font-weight:900;padding-bottom:6px;}
.footer-actions{display:grid;grid-template-columns:1fr 1fr 1fr;}
.footer-actions a{
  text-align:center;padding:16px 0;
  font-weight:900;text-decoration:none;color:#111;
}
.call{background:var(--call);color:#fff;}
.sms{background:var(--sms);color:#fff;}
.kakao{background:var(--kakao);}
</style>
</head>

<body>

<!-- 상단 탭 -->
<div class="tabs">
  <div class="tab active" data-cat="SK">SK</div>
  <div class="tab" data-cat="KT">KT</div>
  <div class="tab" data-cat="LG">LG</div>
</div>

<!-- 카드 영역 -->
<div class="main">
  <div class="grid" id="cards"></div>
</div>

<!-- 하단 -->
<div class="footer">
  <div class="footer-msg">액정필름 무료교체 (카톡주문필수)</div>
  <div class="footer-store">복지관2층매장</div>
  <div class="footer-actions">
    <a class="call" href="tel:042-821-2272">전화</a>
    <a class="sms" href="sms:010-5839-1512">문자</a>
    <a class="kakao" href="https://open.kakao.com/o/s729bI5h" target="_blank">카톡</a>
  </div>
</div>

<script>
const CSV_URL = 'data.csv?v=' + Date.now();
const grid = document.getElementById('cards');
const tabs = document.querySelectorAll('.tab');

/** 최소 CSV 파서 (따옴표 처리) */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').trim().split('\n').filter(Boolean);
  if(lines.length === 0) return [];

  const headers = splitCSVLine(lines.shift()).map(h => h.trim());
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

  return lines.map(line=>{
    const cols = splitCSVLine(line);
    const get = (k)=> (idx[k] != null ? (cols[idx[k]] ?? '').trim() : '');

    return {
      type: get('type'),                 // PHONE / PHONE_LOW / INTV / MVNO
      carrier: get('carrier'),           // SK / KT / LG
      title: get('title'),
      display_price: get('display_price'),
      sub_price: get('sub_price'),
      payout: get('payout'),
      margin_target: get('margin_target'),
      margin_actual: get('margin_actual'),
      warn: get('warn'),                 // OK / WARN
      note: get('note')
    };
  });
}

function splitCSVLine(line){
  const out = [];
  let cur = '';
  let inQ = false;

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      // "" -> "
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === ',' && !inQ){
      out.push(cur);
      cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

/** 탭별로 보여줄 (type, carrier) 매핑 고정 */
function tabFilter(tab){
  if(tab === 'SK') return { type:'PHONE_LOW', carrier:'SK' };
  if(tab === 'KT') return { type:'INTV',      carrier:'KT' };
  if(tab === 'LG') return { type:'MVNO',      carrier:'LG' };
  return { type:'', carrier:'' };
}

/** 가격 표시: 월/원 포함이면 그대로, 숫자면 만원 붙이기 */
function formatPrice(v){
  const s = (v ?? '').toString().trim();
  if(!s) return '';
  if(/[원월]/.test(s)) return s;                // "월 9,900원" 같은 형태
  if(/[가-힣]/.test(s)) return s;               // 이미 "이동 57 / 기변 55" 같이 문자가 있으면 그대로
  // 숫자/마이너스 숫자면 만원 처리
  const n = Number(s.replace(/,/g,''));
  if(!isNaN(n)) return `${s}만원`;
  return s;
}

/** 저가요금특가폰: "이동 57 / 기변 55"면 2장 카드로 분리 */
function splitPhoneCards(row){
  const s = (row.display_price ?? '').trim();
  // 패턴: 이동 57 / 기변 55
  const m = s.match(/이동\s*([-\d.,]+)\s*\/\s*기변\s*([-\d.,]+)/);
  if(!m){
    // 분리 못하면 1장으로
    return [{
      model: row.title,
      price: formatPrice(row.display_price),
      cond: row.note || '저가요금 특가폰',
      sub: row.warn === 'WARN' ? '⚠️ 마진/정책 확인' : (row.sub_price || '')
    }];
  }
  const move = m[1];
  const chg  = m[2];

  const commonSub = row.warn === 'WARN' ? '⚠️ 마진/정책 확인' : (row.sub_price || '');
  const note = row.note || '';

  return [
    {
      model: row.title,
      price: formatPrice(move),
      cond: '번호이동',
      sub: note || commonSub
    },
    {
      model: row.title,
      price: formatPrice(chg),
      cond: '기기변경',
      sub: note || commonSub
    }
  ];
}

function render(tab){
  const want = tabFilter(tab);

  fetch(CSV_URL,{cache:'no-store'})
    .then(r=>r.text())
    .then(t=>{
      const rows = parseCSV(t);

      // 탭에 맞는 행만
      const picked = rows.filter(r =>
        (r.type || '').toUpperCase() === want.type &&
        (r.carrier || '').toUpperCase() === want.carrier
      );

      grid.innerHTML='';

      // 카드 생성
      picked.forEach(r=>{
        if(want.type === 'PHONE_LOW'){
          // 2장 분리
          splitPhoneCards(r).forEach(c=>{
            grid.innerHTML += cardHTML(c.model, c.price, c.cond, c.sub);
          });
        } else if(want.type === 'INTV'){
          // 인터넷TV: display_price에 지급액(또는 보여줄 값)이 들어오도록 엑셀에서 맞춰둔 전제
          const cond = r.note || '인터넷·TV';
          const sub = r.warn === 'WARN' ? '⚠️ 지급액/마진 확인' : (r.sub_price || '');
          grid.innerHTML += cardHTML(r.title, formatPrice(r.display_price), cond, sub);
        } else if(want.type === 'MVNO'){
          // 알뜰요금제: display_price = "월 9,900원" 형태
          const cond = r.note || '알뜰요금제';
          const sub = r.warn === 'WARN' ? '⚠️ 지급액/마진 확인' : (r.sub_price || '');
          grid.innerHTML += cardHTML(r.title, formatPrice(r.display_price), cond, sub);
        }
      });

      if(!grid.innerHTML.trim()){
        grid.innerHTML = `
          <div class="card" style="grid-column:1 / -1;">
            <div class="model">${tab} 항목이 비어있음</div>
            <div class="sub">CSV출력_v2에서 type/carrier가 맞는지 확인하세요.</div>
          </div>
        `;
      }
    })
    .catch(()=>{
      grid.innerHTML = `
        <div class="card" style="grid-column:1 / -1;">
          <div class="model">data.csv 읽기 실패</div>
          <div class="sub">파일명(data.csv)과 업로드 위치를 확인하세요.</div>
        </div>
      `;
    });
}

function cardHTML(model, price, cond, sub){
  return `
  <div class="card">
    <div class="model">${escapeHTML(model)}</div>
    <div class="price">${escapeHTML(price)}</div>
    <div class="cond">${escapeHTML(cond || '')}</div>
    <div class="sub">${escapeHTML(sub || '')}</div>
  </div>`;
}

function escapeHTML(str){
  return (str ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

tabs.forEach(t=>{
  t.onclick=()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    render(t.dataset.cat);
  };
});

render('SK');
</script>

</body>
</html>
