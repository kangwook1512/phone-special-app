<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>복지관2층매장</title>

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --ink:#1f2937;
  --muted:#6b7280;
  --line:#e5e7eb;
  --price:#ef4444;
  --tab:#2563eb;
  --call:#22c55e;
  --sms:#38bdf8;
  --kakao:#fee500;
}
*{box-sizing:border-box;}
html,body{margin:0;padding:0;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* 상단 탭(6개, 2열 3줄) */
.tabs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  background:#fff;
  border-bottom:1px solid var(--line);
}
.tab{
  padding:14px 0;
  text-align:center;
  font-weight:900;
  border-radius:12px;
  background:#f3f4f6;
  cursor:pointer;
  user-select:none;
}
.tab.active{ background:var(--tab); color:#fff; }

/* 카드 */
.main{padding:12px;padding-bottom:190px;}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.card{
  background:var(--card);
  border-radius:18px;
  padding:18px 16px;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
}
.model{font-size:18px;font-weight:900;margin-bottom:8px;}
.price{font-size:32px;font-weight:900;color:var(--price);margin-bottom:10px;}
.cond{font-size:14px;font-weight:800;margin-bottom:6px;}
.sub{font-size:13px;color:var(--muted);font-weight:700;}

/* 섹션(통신사별 묶음) */
.section-title{
  grid-column:1 / -1;
  font-weight:900;
  font-size:14px;
  color:var(--muted);
  padding:6px 4px 0;
}

/* 하단 */
.footer{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-top:1px solid var(--line);
}
.footer-msg{text-align:center;padding:10px;font-size:14px;font-weight:800;}
.footer-store{text-align:center;font-size:18px;font-weight:900;padding-bottom:6px;}
.footer-actions{display:grid;grid-template-columns:1fr 1fr 1fr;}
.footer-actions a{
  text-align:center;padding:16px 0;
  font-weight:900;text-decoration:none;color:#111;
}
.call{background:var(--call);color:#fff;}
.sms{background:var(--sms);color:#fff;}
.kakao{background:var(--kakao);}
</style>
</head>

<body>

<!-- 상단 탭(6개 고정) -->
<div class="tabs">
  <div class="tab active" data-cat="SK">SK</div>
  <div class="tab" data-cat="KT">KT</div>
  <div class="tab" data-cat="LG">LG</div>
  <div class="tab" data-cat="SPECIAL">특가폰</div>
  <div class="tab" data-cat="INTV">인터넷TV</div>
  <div class="tab" data-cat="MVNO">알뜰요금</div>
</div>

<!-- 카드 영역 -->
<div class="main">
  <div class="grid" id="cards"></div>
</div>

<!-- 하단 -->
<div class="footer">
  <div class="footer-msg">액정필름 무료교체 (카톡주문필수)</div>
  <div class="footer-store">복지관2층매장</div>
  <div class="footer-actions">
    <a class="call" href="tel:042-821-2272">전화</a>
    <a class="sms" href="sms:010-5839-1512">문자</a>
    <a class="kakao" href="https://open.kakao.com/o/s729bI5h" target="_blank" rel="noopener">카톡</a>
  </div>
</div>

<script>
const CSV_URL = 'data.csv?v=' + Date.now();
const grid = document.getElementById('cards');
const tabs = Array.from(document.querySelectorAll('.tab'));

/** ====== 안전 원칙 ======
 * - 내부값(마진/리베이트/정산)은 "파싱 자체를 하지 않음" => 화면 노출 경로 0
 * - 화면 출력은 title/display_price/sub_price/warn/note만 사용
 */

/** 최소 CSV 파서 (따옴표 처리) */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').trim().split('\n').filter(Boolean);
  if(lines.length === 0) return [];

  const headers = splitCSVLine(lines.shift()).map(h => h.trim());
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

  return lines.map(line=>{
    const cols = splitCSVLine(line);
    const get = (k)=> (idx[k] != null ? (cols[idx[k]] ?? '').trim() : '');

    return {
      // ✅ 분류/표시에 필요한 것만 파싱 (payout/margin_* 절대 금지)
      type: get('type'),
      carrier: get('carrier') || get('통신사') || get('캐리어') || get('망'),
      title: get('title'),
      display_price: get('display_price'),
      sub_price: get('sub_price'),
      warn: get('warn'),
      note: get('note')
    };
  });
}

function splitCSVLine(line){
  const out = [];
  let cur = '';
  let inQ = false;

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === ',' && !inQ){
      out.push(cur);
      cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function escapeHTML(str){
  return (str ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function cardHTML(model, price, cond, sub){
  return `
  <div class="card">
    <div class="model">${escapeHTML(model)}</div>
    <div class="price">${escapeHTML(price)}</div>
    <div class="cond">${escapeHTML(cond || '')}</div>
    <div class="sub">${escapeHTML(sub || '')}</div>
  </div>`;
}

function T(x){ return (x||'').toString().trim().toUpperCase(); }

/** 통신사 표준화 (휴대폰 탭용: SK/KT/LG로 수렴) */
function normCarrier(v){
  const raw = (v ?? '').toString().trim();
  const x = raw.toUpperCase().replace(/\s+/g,'');

  if (x.includes('SK') || raw.includes('에스케이') || raw.includes('티월드')) return 'SK';
  if (x.includes('KT') || x.includes('KTF') || raw.includes('케이티') || raw.includes('올레')) return 'KT';
  if (x.includes('LG') || x.includes('LGU') || x.includes('U+') || x.includes('UPLUS')
      || raw.includes('엘지') || raw.includes('유플') || raw.includes('유플러스')) return 'LG';

  return x;
}

/** 인터넷/알뜰 탭용: "망" 표기도 보기 좋게 수렴 */
function normNetLabel(v){
  const raw = (v ?? '').toString().trim();
  const x = raw.toUpperCase().replace(/\s+/g,'');

  // 이미 SK망/KT망/LG망이면 그대로
  if (raw.includes('SK망') || x.includes('SK망')) return 'SK망';
  if (raw.includes('KT망') || x.includes('KT망')) return 'KT망';
  if (raw.includes('LG망') || raw.includes('LGU망') || x.includes('LG망') || x.includes('LGU망')) return 'LG망';

  // 통신사 표준화
  const c = normCarrier(raw);
  if (c === 'SK') return 'SK';
  if (c === 'KT') return 'KT';
  if (c === 'LG') return 'LG';

  return raw || '기타';
}

/** 분류용 텍스트 뭉치 */
function blob(r){
  return [
    (r.type||''),
    (r.carrier||''),
    (r.title||''),
    (r.display_price||''),
    (r.sub_price||''),
    (r.note||'')
  ].join(' ').trim();
}

/** 휴대폰 / 인터넷TV / 알뜰 / 특가폰 분류 (CSV 표기 흔들려도 잡히게) */
function isPhoneRow(r){
  const x = T(r.type);
  return x.startsWith('PHONE') || x.includes('MOBILE') || x.includes('HANDSET');
}
function isSpecialRow(r){
  const b = blob(r);
  const x = T(r.type);
  return x.includes('SPECIAL') || b.includes('특가폰') || b.includes('특가');
}
function isIntvRow(r){
  const b = blob(r);
  const x = T(r.type);

  // 휴대폰은 제외
  if (isPhoneRow(r)) return false;

  // type 기반 + 텍스트 기반 혼합
  if (x.includes('INTV') || x.includes('INTERNET') || x.includes('IPTV')) return true;

  // 한글 키워드
  if (b.includes('인터넷')) return true;
  if (b.includes('IPTV')) return true;
  if (b.includes('TV') && !b.includes('갤럭시') && !b.includes('아이폰')) return true; // 폰 모델명 오인 최소화
  if (b.includes('기가') || b.includes('와이파이') || b.includes('WIFI') || b.includes('공유기')) return true;

  return false;
}
function isMvnoRow(r){
  const b = blob(r);
  const x = T(r.type);

  // 휴대폰은 제외
  if (isPhoneRow(r)) return false;

  // type 기반 + 텍스트 기반
  if (x.includes('MVNO') || x.includes('ALTTEL') || x.includes('ALT')) return true;

  if (b.includes('알뜰')) return true;
  if (b.includes('요금제')) return true;

  // 데이터 요금제 패턴(알뜰에서 흔함): "GB + Mbps"
  const hasGB = /(\d+\s*GB)|(\d+\s*기가)/i.test(b);
  const hasMbps = /(\d+\s*MBPS)|(\d+\s*Mbps)/i.test(b);
  if (hasGB && hasMbps) return true;

  // "월 3,300" 같은 월요금 패턴
  if (b.includes('월') && /[\d,]+\s*원/.test(b)) return true;

  return false;
}

/** 가격 표시 */
function formatPrice(v){
  const s = (v ?? '').toString().trim();
  if(!s) return '';
  if(/[원월]/.test(s)) return s;
  if(/[가-힣]/.test(s)) return s;
  const n = Number(s.replace(/,/g,''));
  if(!isNaN(n)) return `${s}만원`;
  return s;
}

/** 휴대폰: "이동 57 / 기변 55"면 2장 카드로 분리 */
function splitPhoneCards(row){
  const s = (row.display_price ?? '').trim();
  const m = s.match(/이동\s*([-\d.,]+)\s*\/\s*기변\s*([-\d.,]+)/);

  // 내부/마진 문구 금지: WARN라도 "조건 확인"만 표시
  const safeSub = (row.warn === 'WARN') ? '조건 확인' : (row.sub_price || '');

  if(!m){
    return [{
      model: row.title,
      price: formatPrice(row.display_price),
      cond: row.note || '이동/기변',
      sub: safeSub
    }];
  }

  const move = m[1];
  const chg  = m[2];
  const note = row.note || '';

  return [
    { model: row.title, price: formatPrice(move), cond: '번호이동', sub: note || safeSub },
    { model: row.title, price: formatPrice(chg),  cond: '기기변경', sub: note || safeSub }
  ];
}

function emptyHTML(msg){
  return `
    <div class="card" style="grid-column:1 / -1;">
      <div class="model">${escapeHTML(msg)}</div>
      <div class="sub">data.csv 내용이 아직 없거나 분류 키워드가 없을 수 있습니다.</div>
    </div>
  `;
}

/** 그룹 렌더 */
function renderGrouped(items, label, netMode){
  const map = new Map();
  items.forEach(r=>{
    const key = netMode ? normNetLabel(r.carrier) : normCarrier(r.carrier);
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(r);
  });

  const order = netMode
    ? ['SK','KT','LG','SK망','KT망','LG망','기타']
    : ['SK','KT','LG','기타'];

  const keys = Array.from(map.keys()).sort((a,b)=>{
    const ia = order.indexOf(a), ib = order.indexOf(b);
    if(ia === -1 && ib === -1) return a.localeCompare(b, 'ko');
    if(ia === -1) return 1;
    if(ib === -1) return -1;
    return ia - ib;
  });

  keys.forEach(k=>{
    grid.insertAdjacentHTML('beforeend', `<div class="section-title">${escapeHTML(label)} · ${escapeHTML(k)}</div>`);
    map.get(k).forEach(r=>{
      grid.insertAdjacentHTML(
        'beforeend',
        cardHTML(r.title, formatPrice(r.display_price), r.note || label, (r.warn === 'WARN') ? '조건 확인' : (r.sub_price || ''))
      );
    });
  });
}

/** 렌더 */
function render(cat){
  fetch(CSV_URL,{cache:'no-store'})
    .then(r=>r.text())
    .then(t=>{
      const rows = parseCSV(t);
      grid.innerHTML='';

      // SK/KT/LG = 이동/기변 휴대폰만
      if(cat === 'SK' || cat === 'KT' || cat === 'LG'){
        const picked = rows.filter(r => isPhoneRow(r) && normCarrier(r.carrier) === cat);

        picked.forEach(r=>{
          splitPhoneCards(r).forEach(c=>{
            grid.insertAdjacentHTML('beforeend', cardHTML(c.model, c.price, c.cond, c.sub));
          });
        });

        if(!grid.innerHTML.trim()){
          grid.innerHTML = emptyHTML(`${cat} 휴대폰 항목이 비어있음`);
        }
        return;
      }

      // 특가폰 (없으면 빈칸 유지)
      if(cat === 'SPECIAL'){
        const picked = rows.filter(r => isSpecialRow(r));
        if(picked.length === 0){
          grid.innerHTML = emptyHTML('특가폰 항목이 비어있음');
          return;
        }
        picked.forEach(r=>{
          grid.insertAdjacentHTML(
            'beforeend',
            cardHTML(r.title, formatPrice(r.display_price), r.note || '특가폰', (r.warn === 'WARN') ? '조건 확인' : (r.sub_price || ''))
          );
        });
        return;
      }

      // 인터넷TV (표기 흔들려도 키워드로 분류)
      if(cat === 'INTV'){
        const picked = rows.filter(r => isIntvRow(r));
        if(picked.length === 0){
          grid.innerHTML = emptyHTML('인터넷TV 항목이 비어있음');
          return;
        }
        renderGrouped(picked, '인터넷TV', false);
        return;
      }

      // 알뜰요금 (표기 흔들려도 키워드로 분류)
      if(cat === 'MVNO'){
        const picked = rows.filter(r => isMvnoRow(r));
        if(picked.length === 0){
          grid.innerHTML = emptyHTML('알뜰요금 항목이 비어있음');
          return;
        }
        renderGrouped(picked, '알뜰요금', true);
        return;
      }

      grid.innerHTML = emptyHTML('항목이 비어있음');
    })
    .catch(()=>{
      grid.innerHTML = `
        <div class="card" style="grid-column:1 / -1;">
          <div class="model">data.csv 읽기 실패</div>
          <div class="sub">파일명(data.csv)과 업로드 위치를 확인하세요.</div>
        </div>
      `;
    });
}

// 탭 클릭
tabs.forEach(t=>{
  t.onclick=()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    render(t.dataset.cat);
  };
});

// 최초 로딩
render('SK');
</script>

</body>
</html>
