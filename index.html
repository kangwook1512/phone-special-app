<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>복지관2층매장</title>

  <style>
    :root{
      --bg:#f5f6f8; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --sk:#2563eb; --kt:#111827; --lg:#16a34a; --hot:#f97316; --low:#7c3aed;
      --call:#22c55e; --sms:#38bdf8; --kakao:#fee500;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    .wrap{max-width:760px;margin:0 auto;padding:14px 12px 18px;}
    .header{
      background:linear-gradient(135deg,#ffffff, #f7fbff);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(160%) blur(6px);
    }
    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .title{
      font-weight:1000;
      letter-spacing:-.5px;
      font-size:22px;
      line-height:1.1;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }
    .countBox{
      text-align:right;
      min-width:112px;
    }
    .countLabel{
      font-size:11px;color:#94a3b8;font-weight:800;
      letter-spacing:-.2px;
    }
    .countNums{
      margin-top:2px;
      font-size:12px;
      font-weight:900;
      color:#334155;
      white-space:nowrap;
    }
    .countNums .sep{color:#cbd5e1;margin:0 6px;font-weight:900;}
    .tabs{
      margin-top:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tabBtn{
      flex:1 1 0;
      min-width:110px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      gap:8px;
      box-shadow:0 2px 10px rgba(15,23,42,.04);
      user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
    .tabBtn.active{color:#fff;border-color:transparent;}
    .tabBtn.active[data-tab="SK"]{background:var(--sk);}
    .tabBtn.active[data-tab="KT"]{background:var(--kt);}
    .tabBtn.active[data-tab="LG"]{background:var(--lg);}
    .tabBtn[data-tab="SK"] .dot{background:var(--sk);}
    .tabBtn[data-tab="KT"] .dot{background:var(--kt);}
    .tabBtn[data-tab="LG"] .dot{background:var(--lg);}

    .notice{
      margin-top:10px;
      background:#fff;
      border:1px dashed #dbeafe;
      border-radius:14px;
      padding:10px 12px;
      color:#475569;
      font-weight:800;
      font-size:12px;
      line-height:1.35;
    }
    .notice b{color:#0f172a;}
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .grid{grid-template-columns:1fr;}
      .title{font-size:20px;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 12px 10px;
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }
    .cardTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .badge{
      font-size:11px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      color:#fff;
      letter-spacing:-.2px;
      white-space:nowrap;
    }
    .badge.SK{background:var(--sk);}
    .badge.KT{background:var(--kt);}
    .badge.LG{background:var(--lg);}
    .name{
      font-weight:1000;
      font-size:15px;
      line-height:1.25;
      letter-spacing:-.3px;
    }
    .price{
      margin-top:10px;
      font-weight:1100;
      font-size:22px;
      letter-spacing:-.6px;
    }
    .price small{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin-left:6px;
    }
    .meta{
      margin-top:6px;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      line-height:1.35;
    }

    .cta{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
    }
    .cta a{
      text-decoration:none;
      display:flex;align-items:center;justify-content:center;
      padding:12px 10px;
      border-radius:14px;
      font-weight:1100;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }
    .cta a.call{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.25);}
    .cta a.sms{background:rgba(56,189,248,.12); border-color:rgba(56,189,248,.25);}
    .cta a.kakao{background:rgba(254,229,0,.35); border-color:rgba(254,229,0,.55);}
    .footerHint{
      margin-top:10px;
      text-align:center;
      font-size:11px;
      color:#94a3b8;
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="header">
      <div class="titleRow">
        <div>
          <div class="title">복지관2층매장</div>
          <div class="sub">SK · KT · LG 특판 / 인터넷TV / 알뜰요금</div>
        </div>

        <!-- ✅ 오늘/누적 표시 영역 (얇고 간단) -->
        <div class="countBox" aria-label="방문자 카운트">
          <div class="countLabel">오늘 <span class="sep"></span> 누적</div>
          <div class="countNums">
            <span id="count-today">-</span>
            <span class="sep">/</span>
            <span id="count-total">-</span>
          </div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="통신사 탭">
        <button class="tabBtn active" data-tab="SK" type="button"><span class="dot"></span>SK 특가폰</button>
        <button class="tabBtn" data-tab="KT" type="button"><span class="dot"></span>KT 인터넷TV</button>
        <button class="tabBtn" data-tab="LG" type="button"><span class="dot"></span>LG 알뜰요금</button>
      </div>

      <div class="notice">
        <b>액정필름 무료교체</b> (카톡 주문 필수)
      </div>

      <div class="cta" aria-label="연락 버튼">
        <a class="call" href="tel:042-821-2272">전화</a>
        <a class="sms" href="sms:010-5839-1512">문자</a>
        <a class="kakao" href="https://open.kakao.com/o/s729bI5h" target="_blank" rel="noopener">카톡</a>
      </div>
      <div class="footerHint">가격/조건은 변동될 수 있어요. 문의 시 더 빠르게 안내됩니다.</div>
    </div>

    <div id="cards" class="grid" aria-live="polite"></div>

  </div>

  <script>
    /************************************************************
     * 1) ✅ “진짜 오늘/누적” 카운터 (CountAPI)
     * - GitHub Pages 정적 사이트에서도 실제로 증가
     * - 새로고침 뻥튀기 방지: 하루 1회(세션)만 +1
     ************************************************************/
    async function updateRealCounters(){
      const todayISO = new Date().toISOString().slice(0,10); // YYYY-MM-DD (UTC 기준)
      // Korea 기준으로 '오늘'을 정확히 맞추려면 KST 변환이 필요하지만,
      // 실사용에서 큰 문제 없게 하려면 아래 KST용 날짜 계산을 사용합니다.
      const now = new Date();
      const kst = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      const todayKST = kst.toISOString().slice(0,10);

      // 새로고침/뒤로가기 뻥튀기 방지 (세션 기준, 하루 1회만 카운트)
      const sessionKey = "counted_" + todayKST;
      const alreadyCounted = sessionStorage.getItem(sessionKey) === "1";

      // namespace는 “내 사이트 고유값”으로 잡아야 충돌이 없습니다.
      // 아래는 사이트 주소 기반으로 안전하게 고정한 값입니다.
      const namespace = "a2272a-github-io";
      const totalKey = "welfare2f_total";
      const todayKey = "welfare2f_" + todayKST;

      // 표시만 먼저 로딩상태 처리
      const elToday = document.getElementById("count-today");
      const elTotal = document.getElementById("count-total");
      if (elToday) elToday.textContent = "…";
      if (elTotal) elTotal.textContent = "…";

      try{
        // 이미 오늘(세션) 카운트 했으면 hit 대신 get(조회)로만 표시
        // CountAPI는 /hit/{namespace}/{key} 로 증가, /get/{namespace}/{key} 로 조회 패턴이 일반적입니다.
        // (hit 엔드포인트 형식 참고) :contentReference[oaicite:1]{index=1}
        const endpoint = (mode, key) => `https://api.countapi.xyz/${mode}/${namespace}/${key}`;

        let totalData, todayData;

        if (alreadyCounted){
          const [t1, t2] = await Promise.all([
            fetch(endpoint("get", totalKey)),
            fetch(endpoint("get", todayKey)),
          ]);
          totalData = await t1.json();
          todayData = await t2.json();
        }else{
          const [t1, t2] = await Promise.all([
            fetch(endpoint("hit", totalKey)),
            fetch(endpoint("hit", todayKey)),
          ]);
          totalData = await t1.json();
          todayData = await t2.json();
          sessionStorage.setItem(sessionKey, "1");
        }

        // 값 표시
        const totalVal = (totalData && typeof totalData.value === "number") ? totalData.value : 0;
        const todayVal = (todayData && typeof todayData.value === "number") ? todayData.value : 0;
        if (elTotal) elTotal.textContent = totalVal.toLocaleString("ko-KR");
        if (elToday) elToday.textContent = todayVal.toLocaleString("ko-KR");

      }catch(err){
        // CountAPI가 일시 장애가 날 수 있어 “표시만 실패”로 처리합니다. :contentReference[oaicite:2]{index=2}
        if (elToday) elToday.textContent = "-";
        if (elTotal) elTotal.textContent = "-";
        console.log("카운터 로딩 실패:", err);
      }
    }

    /************************************************************
     * 2) 카드 렌더링 (data.csv 기반)
     * - CSV가 없거나 에러면 기본 카드 표시
     ************************************************************/
    function parseCSV(text){
      // 아주 단순 CSV 파서 (따옴표/콤마 복잡케이스는 최소화)
      const lines = text.replace(/\r/g,'').trim().split('\n');
      if (lines.length < 2) return [];
      const header = lines[0].split(',').map(s=>s.trim());
      return lines.slice(1).map(line=>{
        const cols = line.split(','); // 기본형
        const obj = {};
        header.forEach((h,i)=> obj[h] = (cols[i] ?? '').trim());
        return obj;
      });
    }

    function cardHTML(item){
      const carrier = (item.carrier || "SK").toUpperCase();
      const title = item.title || "상품명";
      const display = item.display_price || "요금조건 문의";
      const sub = item.sub_price || "";
      const note = item.note || "";
      const badgeClass = (carrier === "KT" ? "KT" : (carrier === "LG" ? "LG" : "SK"));

      return `
        <div class="card">
          <div class="cardTop">
            <div class="name">${escapeHTML(title)}</div>
            <div class="badge ${badgeClass}">${badgeClass}</div>
          </div>
          <div class="price">${escapeHTML(display)}${sub ? `<small>${escapeHTML(sub)}</small>` : ""}</div>
          ${note ? `<div class="meta">${escapeHTML(note)}</div>` : `<div class="meta">상세조건은 문의로 안내드립니다.</div>`}
        </div>
      `;
    }

    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    let allItems = [];
    let activeTab = "SK";

    function render(){
      const box = document.getElementById("cards");
      if (!box) return;

      const filtered = allItems.filter(x => (x.carrier || "").toUpperCase() === activeTab);

      if (filtered.length === 0){
        // 탭별 기본 안내 카드
        const fallback = [
          {carrier:activeTab, title:"특판/조건 안내", display_price:"요금조건 문의", note:"원하시는 기종/이동·기변 말씀해주시면 최저가로 안내합니다."},
          {carrier:activeTab, title:"당일 시세 변동", display_price:"실시간 업데이트", note:"정확한 금액은 카톡 문의가 가장 빠릅니다."}
        ];
        box.innerHTML = fallback.map(cardHTML).join("");
        return;
      }

      box.innerHTML = filtered.map(cardHTML).join("");
    }

    function bindTabs(){
      document.querySelectorAll(".tabBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          activeTab = btn.getAttribute("data-tab") || "SK";
          render();
        });
      });
    }

    async function loadCSV(){
      try{
        const res = await fetch("data.csv?v=" + Date.now(), {cache:"no-store"});
        if (!res.ok) throw new Error("CSV not found");
        const text = await res.text();
        allItems = parseCSV(text);

        // carrier(SK/KT/LG) 없는 행은 제외
        allItems = allItems.filter(x => ["SK","KT","LG"].includes((x.carrier||"").toUpperCase()));
      }catch(e){
        allItems = [];
      }finally{
        render();
      }
    }

    // 실행
    bindTabs();
    loadCSV();
    updateRealCounters();
  </script>
</body>
</html>
