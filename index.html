<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>복지관2층매장</title>

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --ink:#1f2937;
  --muted:#6b7280;
  --line:#e5e7eb;
  --price:#ef4444;
  --tab:#2563eb;
  --call:#22c55e;
  --sms:#38bdf8;
  --kakao:#fee500;
}
*{box-sizing:border-box;}
html,body{margin:0;padding:0;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* 상단 탭(6개, 2열 3줄) */
.tabs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  background:#fff;
  border-bottom:1px solid var(--line);
}
.tab{
  padding:14px 0;
  text-align:center;
  font-weight:900;
  border-radius:12px;
  background:#f3f4f6;
  cursor:pointer;
  user-select:none;
}
.tab.active{ background:var(--tab); color:#fff; }

/* 카드 */
.main{padding:12px;padding-bottom:190px;}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.card{
  background:var(--card);
  border-radius:18px;
  padding:18px 16px;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
}
.model{font-size:18px;font-weight:900;margin-bottom:8px;}
.price{font-size:32px;font-weight:900;color:var(--price);margin-bottom:10px;}
.cond{font-size:14px;font-weight:800;margin-bottom:6px;}
.sub{font-size:13px;color:var(--muted);font-weight:700;}
.section-title{
  grid-column:1 / -1;
  font-weight:900;
  font-size:14px;
  color:var(--muted);
  padding:6px 4px 0;
}

/* 하단 */
.footer{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-top:1px solid var(--line);
}
.footer-msg{text-align:center;padding:10px;font-size:14px;font-weight:800;}
.footer-store{text-align:center;font-size:18px;font-weight:900;padding-bottom:6px;}
.footer-actions{display:grid;grid-template-columns:1fr 1fr 1fr;}
.footer-actions a{
  text-align:center;padding:16px 0;
  font-weight:900;text-decoration:none;color:#111;
}
.call{background:var(--call);color:#fff;}
.sms{background:var(--sms);color:#fff;}
.kakao{background:var(--kakao);}
</style>
</head>

<body>

<div class="tabs">
  <div class="tab active" data-cat="SK">SK</div>
  <div class="tab" data-cat="KT">KT</div>
  <div class="tab" data-cat="LG">LG</div>
  <div class="tab" data-cat="SPECIAL">특가폰</div>
  <div class="tab" data-cat="INTV">인터넷TV</div>
  <div class="tab" data-cat="MVNO">알뜰요금</div>
</div>

<div class="main">
  <div class="grid" id="cards"></div>
</div>

<div class="footer">
  <div class="footer-msg">액정필름 무료교체 (카톡주문필수)</div>
  <div class="footer-store">복지관2층매장</div>
  <div class="footer-actions">
    <a class="call" href="tel:042-821-2272">전화</a>
    <a class="sms" href="sms:010-5839-1512">문자</a>
    <a class="kakao" href="https://open.kakao.com/o/s729bI5h" target="_blank" rel="noopener">카톡</a>
  </div>
</div>

<script>
const CSV_URL = 'data.csv?v=' + Date.now();
const grid = document.getElementById('cards');
const tabs = Array.from(document.querySelectorAll('.tab'));

/* ===== 공통 유틸 ===== */
function T(x){ return (x||'').toString().trim().toUpperCase(); }
function escapeHTML(str){
  return (str ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
function cardHTML(model, price, cond, sub){
  return `
  <div class="card">
    <div class="model">${escapeHTML(model)}</div>
    <div class="price">${escapeHTML(price)}</div>
    <div class="cond">${escapeHTML(cond || '')}</div>
    <div class="sub">${escapeHTML(sub || '')}</div>
  </div>`;
}
function emptyHTML(msg){
  return `
    <div class="card" style="grid-column:1 / -1;">
      <div class="model">${escapeHTML(msg)}</div>
      <div class="sub">data.csv 헤더/구분자(콤마·탭)를 자동으로 맞추는 버전입니다.</div>
    </div>
  `;
}

/* ====== CSV/TSV 자동 파서 ====== */
function detectDelimiter(firstLine){
  // 탭이 더 많으면 TSV로 판단
  const commas = (firstLine.match(/,/g) || []).length;
  const tabs = (firstLine.match(/\t/g) || []).length;
  return (tabs > commas) ? '\t' : ',';
}

function splitLine(line, delim){
  if(delim === '\t'){
    // TSV는 따옴표 처리 거의 없음(엑셀 TSV). 그냥 split.
    return line.split('\t');
  }
  // CSV(콤마) + 따옴표 처리
  const out = [];
  let cur = '';
  let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === ',' && !inQ){
      out.push(cur); cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function parseTable(text){
  const rawLines = text.replace(/\r/g,'').trim().split('\n').filter(Boolean);
  if(rawLines.length === 0) return { headers:[], rows:[] };

  const delim = detectDelimiter(rawLines[0]);
  const headers = splitLine(rawLines[0], delim).map(h=>h.trim());
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));

  const rows = rawLines.slice(1).map(line=>{
    const cols = splitLine(line, delim);
    const get = (k)=> (idx[k] != null ? (cols[idx[k]] ?? '').toString().trim() : '');
    const getAny = (keys)=> {
      for(const k of keys){
        const v = get(k);
        if(v) return v;
      }
      return '';
    };

    // ✅ 내부값(마진/리베이트/정산) 파싱 금지: 아예 읽지 않음

    // 헤더 자동 매칭(영문/한글/변형 대응)
    const type   = getAny(['type','TYPE','category','카테고리','구분','분류','상품구분','종류']);
    const carrier= getAny(['carrier','CARRIER','통신사','망','통신망','네트워크','이통사']);
    const title  = getAny(['title','TITLE','모델','모델명','상품명','이름','제목','상품']);
    const display_price = getAny(['display_price','DISPLAY_PRICE','가격','표시가','판매가','월 요금','월요금','요금','금액']);
    const sub_price = getAny(['sub_price','SUB_PRICE','조건','부가','세부조건','설명','데이터','통화','문자']);
    const warn  = getAny(['warn','WARN','상태','표시','노출','flag']);
    const note  = getAny(['note','NOTE','메모','비고','안내','문구']);

    return { type, carrier, title, display_price, sub_price, warn, note };
  });

  return { headers, rows };
}

/* ===== 분류 규칙 ===== */
function normCarrier(v){
  const raw = (v ?? '').toString().trim();
  const x = raw.toUpperCase().replace(/\s+/g,'');

  if (x.includes('SK') || raw.includes('에스케이') || raw.includes('티월드')) return 'SK';
  if (x.includes('KT') || x.includes('KTF') || raw.includes('케이티') || raw.includes('올레') ) return 'KT';
  if (x.includes('LG') || x.includes('LGU') || x.includes('U+') || x.includes('UPLUS')
      || raw.includes('엘지') || raw.includes('유플') || raw.includes('유플러스')) return 'LG';

  return x;
}

function formatPrice(v){
  const s = (v ?? '').toString().trim();
  if(!s) return '';
  // 이미 월/원/한글 포함이면 그대로
  if(/[원월]/.test(s)) return s;
  if(/[가-힣]/.test(s)) return s;
  const n = Number(s.replace(/,/g,''));
  if(!isNaN(n)) return `${s}만원`;
  return s;
}

function isPhoneRow(r){
  const x = T(r.type);
  // PHONE* 또는 휴대폰 관련 키워드
  if (x.startsWith('PHONE')) return true;
  const b = `${r.type} ${r.title} ${r.note}`.toString();
  return b.includes('휴대폰') || b.includes('핸드폰') || b.includes('갤럭시') || b.includes('아이폰');
}

function isIntvRow(r){
  if (isPhoneRow(r)) return false;
  const b = `${r.type} ${r.title} ${r.note} ${r.sub_price}`.toString();
  return b.includes('인터넷') || b.includes('IPTV') || b.includes('TV') || b.includes('기가') || b.includes('와이파이') || b.toUpperCase().includes('WIFI');
}

function isMvnoRow(r){
  if (isPhoneRow(r)) return false;
  const b = `${r.type} ${r.title} ${r.note} ${r.sub_price}`.toString();
  const up = b.toUpperCase();
  if (b.includes('알뜰')) return true;
  if (b.includes('요금제')) return true;
  if (up.includes('MVNO') || up.includes('ALTTEL')) return true;
  // 알뜰 데이터 패턴
  if (/(\d+\s*GB)|(\d+\s*기가)/i.test(b) && /(\d+\s*MBPS)|(\d+\s*Mbps)/i.test(b)) return true;
  if (b.includes('월') && /[\d,]+\s*원/.test(b)) return true;
  return false;
}

function isSpecialRow(r){
  const b = `${r.type} ${r.title} ${r.note}`.toString();
  const up = b.toUpperCase();
  return up.includes('SPECIAL') || b.includes('특가');
}

/* 휴대폰 이동/기변 분리 */
function splitPhoneCards(row){
  const s = (row.display_price ?? '').trim();
  const m = s.match(/이동\s*([-\d.,]+)\s*\/\s*기변\s*([-\d.,]+)/);

  const safeSub = (row.warn === 'WARN') ? '조건 확인' : (row.sub_price || '');

  if(!m){
    return [{
      model: row.title,
      price: formatPrice(row.display_price),
      cond: row.note || '이동/기변',
      sub: safeSub
    }];
  }
  return [
    { model: row.title, price: formatPrice(m[1]), cond: '번호이동', sub: row.note || safeSub },
    { model: row.title, price: formatPrice(m[2]), cond: '기기변경', sub: row.note || safeSub }
  ];
}

/* 그룹 렌더 */
function renderGrouped(items, label){
  const map = new Map();
  items.forEach(r=>{
    const key = (r.carrier || '').trim() || '기타';
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(r);
  });

  const keys = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b,'ko'));
  keys.forEach(k=>{
    grid.insertAdjacentHTML('beforeend', `<div class="section-title">${escapeHTML(label)} · ${escapeHTML(k)}</div>`);
    map.get(k).forEach(r=>{
      grid.insertAdjacentHTML('beforeend',
        cardHTML(r.title, formatPrice(r.display_price), r.note || label, (r.warn === 'WARN') ? '조건 확인' : (r.sub_price || ''))
      );
    });
  });
}

/* 렌더 */
function render(cat){
  fetch(CSV_URL,{cache:'no-store'})
    .then(r=>r.text())
    .then(t=>{
      const parsed = parseTable(t);
      const rows = parsed.rows;
      grid.innerHTML='';

      // SK/KT/LG = 이동/기변 휴대폰만
      if(cat === 'SK' || cat === 'KT' || cat === 'LG'){
        const picked = rows.filter(r => isPhoneRow(r) && normCarrier(r.carrier) === cat);
        picked.forEach(r=>{
          splitPhoneCards(r).forEach(c=>{
            grid.insertAdjacentHTML('beforeend', cardHTML(c.model, c.price, c.cond, c.sub));
          });
        });
        if(!grid.innerHTML.trim()) grid.innerHTML = emptyHTML(`${cat} 휴대폰 항목이 비어있음`);
        return;
      }

      if(cat === 'SPECIAL'){
        const picked = rows.filter(r => isSpecialRow(r));
        if(picked.length === 0){ grid.innerHTML = emptyHTML('특가폰 항목이 비어있음'); return; }
        picked.forEach(r=>{
          grid.insertAdjacentHTML('beforeend',
            cardHTML(r.title, formatPrice(r.display_price), r.note || '특가폰', (r.warn === 'WARN') ? '조건 확인' : (r.sub_price || ''))
          );
        });
        return;
      }

      if(cat === 'INTV'){
        const picked = rows.filter(r => isIntvRow(r));
        if(picked.length === 0){ grid.innerHTML = emptyHTML('인터넷TV 항목이 비어있음'); return; }
        renderGrouped(picked, '인터넷TV');
        return;
      }

      if(cat === 'MVNO'){
        const picked = rows.filter(r => isMvnoRow(r));
        if(picked.length === 0){ grid.innerHTML = emptyHTML('알뜰요금 항목이 비어있음'); return; }
        renderGrouped(picked, '알뜰요금');
        return;
      }

      grid.innerHTML = emptyHTML('항목이 비어있음');
    })
    .catch(()=>{
      grid.innerHTML = `
        <div class="card" style="grid-column:1 / -1;">
          <div class="model">data.csv 읽기 실패</div>
          <div class="sub">파일명(data.csv)과 업로드 위치를 확인하세요.</div>
        </div>
      `;
    });
}

/* 탭 클릭 */
tabs.forEach(t=>{
  t.onclick=()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    render(t.dataset.cat);
  };
});

render('SK');
</script>

</body>
</html>
