<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>복지관 2층 휴대폰 특판 안내</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#5b667a;
      --line:#e6eaf2;
      --chip:#eef3ff;
      --chipInk:#1e3a8a;
      --danger:#b91c1c;
      --shadow: 0 6px 18px rgba(10, 20, 40, .08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    /* 상단 영역: 모바일에서 너무 크지 않게 */
    header{
      position: sticky;
      top:0;
      z-index: 10;
      background: rgba(246,248,251,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .head{
      padding: 10px 12px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brand .t1{
      font-weight: 900;
      font-size: 16px;   /* 간판 크기 줄임 */
      line-height: 1.1;
      letter-spacing:-.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .t2{
      font-size: 12px;
      color: var(--muted);
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* 탭: 1줄 가로 스크롤 */
    .tabs{
      display:flex;
      gap:8px;
      padding: 8px 10px 10px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      flex:0 0 auto;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      line-height:1;
      box-shadow: 0 2px 10px rgba(10,20,40,.04);
    }
    .tab[aria-selected="true"]{
      background: var(--chip);
      border-color: #c7d6ff;
      color: var(--chipInk);
    }

    /* 본문: 카드가 최대한 크게 보이도록 */
    main{
      padding: 12px;
      padding-bottom: 24px; /* 하단바 없으니 최소 여백만 */
      max-width: 980px;
      margin: 0 auto;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 2px 12px;
    }
    .count{
      font-size: 13px;
      color: var(--muted);
    }
    .search{
      width: min(360px, 52vw);
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (min-width: 760px){
      .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (min-width: 1020px){
      .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 150px;
    }
    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-size: 15px;
      font-weight: 900;
      letter-spacing:-.2px;
      line-height:1.15;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      line-height:1.2;
    }
    .badge{
      flex:0 0 auto;
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      border:1px solid var(--line);
      color:#0f172a;
      white-space:nowrap;
    }
    .price{
      font-size: 24px;       /* 가격은 크게 */
      font-weight: 1000;
      letter-spacing:-.6px;
      line-height:1;
    }
    .price small{
      font-size: 14px;
      font-weight: 900;
      color: var(--muted);
      margin-left: 4px;
    }
    .desc{
      font-size: 13px;
      color: #1f2937;
      line-height: 1.35;
      word-break: keep-all;
    }
    .foot{
      margin-top:auto;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      font-size: 12px;
      font-weight: 800;
      color: var(--chipInk);
      background: var(--chip);
      border: 1px solid #c7d6ff;
      padding: 6px 10px;
      border-radius: 999px;
    }

    /* 상태/오류 안내 */
    .state{
      border:1px dashed var(--line);
      border-radius: var(--radius);
      background:#fff;
      padding: 14px;
      color: var(--muted);
      line-height:1.45;
    }
    .state b{ color: var(--ink); }
    .state .err{ color: var(--danger); font-weight:900; }

    /* 클릭 고정(원하면) */
    .pin-hint{
      font-size:12px;
      color:var(--muted);
      margin-left:8px;
    }
  </style>
</head>

<body>
  <header>
    <div class="head">
      <div class="brand">
        <div class="t1">복지관 2층 휴대폰 특판</div>
        <div class="t2">SK · KT · LG · 인터넷/TV · 알뜰요금</div>
      </div>
      <div class="meta" id="lastUpdated">로딩중…</div>
    </div>

    <!-- 탭: 1줄 스크롤 -->
    <div class="tabs" id="tabs" role="tablist" aria-label="카테고리 탭"></div>
  </header>

  <main>
    <div class="toolbar">
      <div class="count">
        <span id="activeTabLabel">전체</span>
        <span class="pin-hint">· 카드 터치 시 상단 고정(선택)</span>
        <div id="countText"></div>
      </div>
      <input class="search" id="q" placeholder="검색 (예: 아이폰, S25, 요금, 인터넷)" />
    </div>

    <div id="state" class="state" style="display:none;"></div>
    <div id="grid" class="grid"></div>
  </main>

  <script>
    // ====== “임의로 만들지 않기” 원칙: 필요한 최소만 ======
    // 1) 탭 1줄 스크롤
    // 2) 상단 간판/바 최소화
    // 3) 카드 꽉 차게 + 가격 크게
    // 4) CSV 비면 안내 + 샘플 fallback (화면이 비어보이지 않게)

    const CSV_URL = 'data.csv';

    // CSV 컬럼(헤더) 권장:
    // category, carrier, title, subtitle, badge, price, price_unit, desc, chips, sort
    // chips는 "현금지원|공시/선약|당일개통" 처럼 | 로 구분
    // sort는 숫자(작을수록 위)

    const sampleRows = [
      {category:'휴대폰', carrier:'SK', title:'아이폰 17', subtitle:'번호이동 / 기변', badge:'특가', price:'0', price_unit:'원', desc:'매장 특판 조건에 따라 변동될 수 있어요.', chips:'공시/선약|당일개통', sort:'10'},
      {category:'휴대폰', carrier:'KT', title:'갤럭시 S25', subtitle:'번호이동', badge:'지원금', price:'70,000', price_unit:'원', desc:'조건 충족 시 최저가 안내.', chips:'현금지원|재고확인', sort:'20'},
      {category:'휴대폰', carrier:'LG', title:'플립', subtitle:'기변', badge:'핫딜', price:'340,000', price_unit:'원', desc:'색상/용량별 상이.', chips:'빠른개통|재고확인', sort:'30'},
      {category:'알뜰요금', carrier:'MVNO', title:'월 3,300원~', subtitle:'추가비용 없음', badge:'알뜰', price:'3,300', price_unit:'원', desc:'가입비/유심비 등 추가비용 일체 없음(조건은 매장 안내).', chips:'초저가|유심/개통', sort:'5'},
      {category:'인터넷TV', carrier:'SK/KT/LG', title:'인터넷+TV', subtitle:'현금 최대 지급', badge:'결합', price:'상담', price_unit:'', desc:'설치 가능 지역/상품에 따라 상이.', chips:'현금지급|가족결합', sort:'40'},
    ];

    const els = {
      tabs: document.getElementById('tabs'),
      grid: document.getElementById('grid'),
      state: document.getElementById('state'),
      q: document.getElementById('q'),
      lastUpdated: document.getElementById('lastUpdated'),
      countText: document.getElementById('countText'),
      activeTabLabel: document.getElementById('activeTabLabel'),
    };

    let rows = [];
    let activeCategory = '전체';
    let pinnedId = null;

    function nowKST(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function showState(html){
      els.state.style.display = 'block';
      els.state.innerHTML = html;
    }
    function hideState(){
      els.state.style.display = 'none';
      els.state.innerHTML = '';
    }

    function parseCSV(text){
      // 간단/안정형 CSV 파서 (따옴표 포함 대응)
      const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
      if(!lines.length) return {ok:false, err:'CSV 내용이 비어있음'};
      const header = splitCSVLine(lines[0]).map(h => h.trim());
      const required = ['category','title','price'];
      const missing = required.filter(k => !header.includes(k));
      if(missing.length){
        return {ok:false, err:`CSV 헤더가 부족합니다: ${missing.join(', ')} (첫 줄에 헤더가 있어야 함)`};
      }
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx) => obj[h] = (cols[idx] ?? '').trim());
        // 기본값 보정
        obj.carrier ||= '';
        obj.subtitle ||= '';
        obj.badge ||= '';
        obj.price_unit ||= '원';
        obj.desc ||= '';
        obj.chips ||= '';
        obj.sort ||= '9999';
        // id
        obj._id = `${i}-${obj.category}-${obj.title}-${obj.carrier}`.replace(/\s+/g,'');
        out.push(obj);
      }
      return {ok:true, rows: out};
    }

    function splitCSVLine(line){
      const res = [];
      let cur = '';
      let q = false;
      for(let i=0;i<line.length;i++){
        const c = line[i];
        if(c === '"'){
          if(q && line[i+1] === '"'){ cur += '"'; i++; }
          else q = !q;
        } else if(c === ',' && !q){
          res.push(cur); cur='';
        } else {
          cur += c;
        }
      }
      res.push(cur);
      return res;
    }

    function categoriesFrom(rows){
      const set = new Set(rows.map(r => r.category).filter(Boolean));
      return ['전체', ...Array.from(set)];
    }

    function renderTabs(){
      const cats = categoriesFrom(rows);
      els.tabs.innerHTML = cats.map(cat => `
        <button class="tab" role="tab"
          aria-selected="${cat===activeCategory}"
          data-cat="${escapeHtml(cat)}">${escapeHtml(cat)}</button>
      `).join('');

      els.tabs.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => {
          activeCategory = btn.dataset.cat;
          pinnedId = null; // 탭 바꾸면 고정 해제(혼란 방지)
          render();
        });
      });
    }

    function escapeHtml(s){
      return (s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function normalize(s){ return (s||'').toLowerCase(); }

    function filteredRows(){
      const q = normalize(els.q.value);
      let list = rows.slice();

      if(activeCategory !== '전체'){
        list = list.filter(r => r.category === activeCategory);
      }
      if(q){
        list = list.filter(r => {
          const blob = [
            r.category, r.carrier, r.title, r.subtitle, r.badge, r.price, r.desc, r.chips
          ].join(' ');
          return normalize(blob).includes(q);
        });
      }
      list.sort((a,b) => Number(a.sort||9999) - Number(b.sort||9999));
      return list;
    }

    function render(){
      // tabs
      els.tabs.querySelectorAll('.tab').forEach(t => {
        t.setAttribute('aria-selected', String(t.dataset.cat === activeCategory));
      });

      const list = filteredRows();
      els.activeTabLabel.textContent = activeCategory;
      els.countText.textContent = `표시: ${list.length}개`;

      if(!list.length){
        els.grid.innerHTML = '';
        showState(`
          <div><b>표시할 카드가 없습니다.</b></div>
          <div>1) <span class="err">data.csv</span> 업로드가 되었는지 확인</div>
          <div>2) 현재 탭/검색어 때문에 필터로 0개가 되었을 수 있습니다.</div>
        `);
        return;
      }
      hideState();

      // pinned 우선
      const pinned = pinnedId ? list.find(r => r._id === pinnedId) : null;
      const rest = pinned ? list.filter(r => r._id !== pinnedId) : list;
      const finalList = pinned ? [pinned, ...rest] : rest;

      els.grid.innerHTML = finalList.map(r => cardHtml(r)).join('');

      // card click => pin (선택 기능)
      els.grid.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.getAttribute('data-id');
          pinnedId = (pinnedId === id) ? null : id;
          render();
          window.scrollTo({top:0, behavior:'smooth'});
        });
      });
    }

    function cardHtml(r){
      const chips = (r.chips||'').split('|').map(s => s.trim()).filter(Boolean);
      const price = escapeHtml(r.price || '');
      const unit = escapeHtml(r.price_unit || '');
      const badge = escapeHtml(r.badge || '');
      const title = escapeHtml(r.title || '');
      const subtitle = escapeHtml(r.subtitle || '');
      const carrier = escapeHtml(r.carrier || '');
      const desc = escapeHtml(r.desc || '');

      return `
        <div class="card" data-id="${escapeHtml(r._id)}">
          <div class="row">
            <div>
              <div class="title">${title}</div>
              <div class="sub">${[carrier, subtitle].filter(Boolean).join(' · ')}</div>
            </div>
            ${badge ? `<div class="badge">${badge}</div>` : ``}
          </div>

          <div class="row" style="align-items:flex-end;">
            <div class="price">${price}${unit ? `<small>${unit}</small>` : ``}</div>
          </div>

          ${desc ? `<div class="desc">${desc}</div>` : ``}

          ${chips.length ? `
            <div class="foot">
              ${chips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join('')}
            </div>
          ` : ``}
        </div>
      `;
    }

    async function load(){
      els.lastUpdated.textContent = `업데이트 ${nowKST()}`;
      try{
        const res = await fetch(CSV_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('CSV fetch 실패: ' + res.status);
        const text = await res.text();
        const parsed = parseCSV(text);
        if(!parsed.ok){
          // CSV 구조 문제가 있으면 샘플로라도 화면이 비지 않게
          rows = sampleRows.map((r, i) => ({...r, _id:`s-${i}`}));
          renderTabs();
          render();
          showState(`
            <div><b class="err">CSV를 읽었지만 구조가 맞지 않아 샘플로 표시 중입니다.</b></div>
            <div>${escapeHtml(parsed.err)}</div>
            <div style="margin-top:8px;"><b>해결:</b> data.csv 첫 줄(헤더)에
              <span class="err">category,title,price</span>는 반드시 포함하세요.</div>
          `);
          return;
        }
        rows = parsed.rows;
        renderTabs();
        render();
      }catch(e){
        // CSV 자체가 없을 때도 샘플로 표시(빈화면 방지)
        rows = sampleRows.map((r, i) => ({...r, _id:`s-${i}`}));
        renderTabs();
        render();
        showState(`
          <div><b class="err">data.csv를 못 불러와서 샘플로 표시 중입니다.</b></div>
          <div>원인: ${escapeHtml(String(e.message || e))}</div>
          <div style="margin-top:8px;"><b>해결:</b> index.html과 같은 폴더에 <span class="err">data.csv</span>를 업로드하세요.</div>
        `);
      }
    }

    els.q.addEventListener('input', () => render());

    load();
  </script>
</body>
</html>
